# LINE通知のバッチ処理実装方針

## 課題

現在、S3に画像がアップロードされるたびにLambdaが呼び出され、LINE通知が送信される。
本番環境では5秒に1回、各部屋から画像がアップロードされるため、通知が大量に発生してしまう。

**例**: 3部屋 × 12回/分 = 36通知/分 → **多すぎる**

## 目標

複数の画像アップロードを1グループにまとめて、1回の通知にしたい。

---

## 実装案

### 案1: SQS + Lambda バッチ処理

```
S3 → SQS (バッファリング) → Lambda (バッチ処理) → LINE通知
```

**メリット**:
- AWSネイティブな構成
- バッチサイズと待機時間を柔軟に設定可能
- 部分的な失敗に対応可能

**デメリット**:
- SQSの追加コスト（微小）
- 最大待機時間の遅延が発生

**設定項目**:
- `batch_size`: 一度に処理するメッセージ数（1-10000）
- `maximum_batching_window_in_seconds`: 待機時間（0-300秒）

---

### 案2: EventBridge Scheduler + 定期実行Lambda

```
S3 → DynamoDB/S3 (イベント記録) → EventBridge (定期トリガー) → Lambda → LINE通知
```

**メリット**:
- 通知タイミングを完全にコントロール可能
- 定期的な集計処理に向いている

**デメリット**:
- 構成が複雑
- 状態管理が必要（DynamoDBなど）

---

### 案3: Step Functions

```
S3 → Lambda → Step Functions (Wait + 集約) → LINE通知
```

**メリット**:
- ワークフローを視覚化できる
- 複雑なロジックに対応

**デメリット**:
- オーバーエンジニアリングかも
- Step Functionsの追加コスト

---

## 検討事項

### Q1: どのくらいの頻度で通知を送りたい？

- [ ] 30秒ごと
- [ ] 1分ごと
- [ ] 5分ごと
- [ ] その他: __________

### Q2: 通知に含めたい情報は？

- [ ] アップロードされた画像の枚数
- [ ] ファイル名一覧（一部）
- [ ] 部屋ごとの内訳
- [ ] CloudFront URL（画像リンク）
- [ ] その他: __________

### Q3: エラー時の挙動は？

- [ ] 再試行してほしい
- [ ] エラーログだけ残してスキップ
- [ ] Dead Letter Queueに送信

### Q4: 既存のS3 → Lambda直接呼び出しは残す？

- [ ] 完全にSQS経由に切り替える
- [ ] 両方残す（別用途で使う可能性）

---

## 次のステップ

1. 上記の検討事項を決定
2. 選択した案の詳細設計
3. Terraform/Pythonコードの実装
4. テスト・デプロイ

---

## メモ欄

（ここに追加の要件や気づきを記載）


